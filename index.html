<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventário de Comportamento Adaptativo</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}
  .section{margin:18px 0 8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);font-weight:700}
  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{display:grid;grid-template-columns:repeat(3,minmax(200px,1fr));gap:10px}
  @media (max-width:820px){ .scale{grid-template-columns:1fr} }
  .opt{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--chip);cursor:pointer;transition:background .15s,border-color .15s,transform .05s}
  .opt:hover{background:var(--chipHover);border-color:#4f70ff;transform:translateY(-1px)}
  .opt input{appearance:none;-webkit-appearance:none;width:0;height:0;position:absolute;opacity:0}
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){background:var(--chipSel);border-color:#6d28d9;box-shadow:0 0 0 1px #6d28d9 inset}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#6d28d9,#10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Inventário de Comportamento Adaptativo (Paciente)</h1>
    <p class="muted">
      Pontuação: <b>2</b>=geralmente realiza sem ajuda · <b>1</b>=às vezes realiza sem ajuda · <b>0</b>=nunca/necessita de ajuda.
    </p>

    <div class="legend">
      <span class="pill">0 = Nunca / com ajuda</span>
      <span class="pill">1 = Às vezes sem ajuda</span>
      <span class="pill">2 = Geralmente sem ajuda</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none;gap:8px;align-items:center;margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/0</span>
        <button id="clearDraft" class="btn ghost" type="button">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px;display:none" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_VINELAND3_ENTREVISTA" };
const CODE = "VINELAND3_ENTREVISTA";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["VINELAND3_ENTREVISTA"]; // coluna(s) de liberação no Patients, com valor "sim"

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return; el.textContent=text; el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display="block"; }
function hideBox(id){ const el=$(id); if(!el) return; el.style.display="none"; el.textContent=""; }
function maskCPF(cpf){ const d=onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d]=String(iso).split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:iso; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){ const usp=new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ const r=await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({data:[row]})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetPatchBy(sheet, column, value, data){ const r=await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,{method:"PATCH",headers:{ "Content-Type":"application/json" },body:JSON.stringify({data})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
const TOKEN = qs("token");
function goPortalWithToken(){
  try{ const u=new URL(PORTAL_URL,location.href); if(TOKEN) u.searchParams.set("token",TOKEN); location.href=u.toString(); }
  catch(_){ const sep=PORTAL_URL.includes("?")?"&":"?"; location.href=PORTAL_URL+(TOKEN?sep+"token="+encodeURIComponent(TOKEN):""); }
}

/* ========= DOMÍNIOS E ITENS ========= */
const DOMAINS = [
  {
    key:"COM",
    label:"Comunicação",
    items: [
`Você usa com naturalidade verbos de ação do cotidiano (ex.: beber, comer, trabalhar, dirigir)?`,
`Seu vocabulário é amplo nas conversas? Aproximadamente quantas palavras diferentes você costuma usar?`,
`Quando alguém pergunta o que, você entende e responde de forma direta?`,
`Quando alguém pergunta onde, você entende e responde de forma direta?`,
`Quando alguém pergunta quem, você entende e responde de forma direta?`,
`Você forma frases simples com sujeito e verbo com facilidade?`,
`Você usa adjetivos para qualificar pessoas e objetos (ex.: limpo, bonito, grande, alto)?`,
`Você usa pronomes possessivos adequadamente (meu, nossa, seu) no dia a dia?`,
`Você usa pronomes e faz concordância de gênero e número corretamente?`,
`Você usa termos espaciais como atrás, na frente e entre de forma adequada?`,
`Você segue instruções com duas etapas relacionadas (ex.: pegar um documento e assiná-lo)?`,
`Você segue instruções com duas etapas não relacionadas (ex.: fechar o e-mail e abrir a planilha)?`,
`Você executa sequências de três passos (ex.: imprimir, grampear e protocolar)?`,
`Você entende e aplica instruções condicionais do tipo se… então (ex.: se o cliente não responder, então ligue)?`,
`Quando combinam algo para mais tarde, você lembra de fazer na hora certa sem lembrete?`,
`Você informa seu nome como prefere ser chamado sem hesitar?`,
`Você informa seu nome completo corretamente quando precisa?`,
`Você informa seu endereço completo sem consultar documentos?`,
`Você informa mês e dia do seu aniversário com facilidade?`,
`Você mantém atenção em uma história por pelo menos 15 minutos?`,
`Você assiste a um episódio de série ou programa por cerca de 30 minutos acompanhando a trama?`,
`Você mantém atenção por 60 minutos em um filme ou programa e entende o que acontece?`,
`Em palestras curtas (15 minutos), você se mantém atento e compreende o conteúdo?`,
`Em apresentações de 30 minutos, você se mantém atento e entende o que está sendo dito?`,
`Você consegue contar de forma organizada o enredo de um filme ou de uma história real?`,
`Você expressa opiniões e interpretações próprias sobre acontecimentos e emoções de outras pessoas?`,
`Você relata seu dia com detalhes úteis (quem estava, onde foi, o que fez)?`,
`Quando não é compreendido, você reformula com outras palavras até ser entendido?`,
`Você identifica esquerda e direita no próprio corpo sem confundir?`,
`Você segue direções com esquerda e direita em deslocamentos (virar à esquerda, olhar à direita)?`,
`Você escreve seu nome completo sem erros?`,
`Sem consultar, você consegue escrever listas com ao menos 10 palavras comuns (ex.: lista de compras)?`,
`Você escreve frases e pequenos parágrafos com sentido claro (mesmo que com pequenos erros)?`,
`Você escreve e-mails ou textos com cerca de 10 frases, com início, meio e fim?`,
`Você usa ordem alfabética para localizar nomes e encontra palavras em índices ou dicionários?`,
`Você entende instruções visuais (manuais, esquemas, mapas) e consegue segui-las?`,
`Você usa sumário, índice ou busca para achar informações em livros e arquivos digitais?`,
`Você usa internet ou acervo de biblioteca para pesquisar e concluir tarefas ou trabalhos?`,
`Você lê e entende textos simples do dia a dia (bilhetes, mensagens curtas)?`,
`Você lê e entende notícias e textos informativos de 1–2 páginas?`,
`Você lê e entende textos mais densos de revista ou capítulos introdutórios?`,
`Você lê e entende textos complexos e técnicos (manuais, relatórios, contratos)?`,
`Você faz resumos com pelo menos três frases usando suas próprias palavras?`,
`Você escreve relatórios ou textos de pelo menos uma página com suas próprias palavras?`,
`Antes de enviar, você revisa e corrige seu texto (pontuação, ortografia, gramática), usando corretor quando necessário?`
    ]
  },
  {
    key:"AVD",
    label:"Atividades de Vida Diária",
    items: [
`Você usa naturalmente copos/xícaras de vidro no dia a dia?`,
`Você se alimenta usando colher sem derramar?`,
`Você corta alimentos fáceis com faca de mesa com segurança?`,
`Você urina no vaso sanitário de forma independente?`,
`Você evacua no vaso sanitário de forma independente?`,
`Você usa o banheiro de dia e de noite sem ajuda, higieniza-se, dá descarga e lava as mãos?`,
`Você lava e seca as mãos com sabonete sem precisar de ajuda para abrir/fechar a torneira?`,
`Você toma banho e se seca sozinho(a), sem precisar que alguém ajuste a água?`,
`Você se veste com as roupas no lado correto (frente/verso) sem confundir?`,
`Você calça os sapatos nos pés corretos e amarra cadarços/fecha velcro com segurança?`,
`Você tem cuidado com superfícies/objetos quentes como fogão e forno?`,
`Você tem cuidado ao usar objetos pontiagudos como tesouras e facas?`,
`Você sabe o que fazer em situações perigosas (pedir ajuda, ligar 190, afastar-se do risco)?`,
`Você usa com segurança eletrodomésticos e ferramentas (aspirador, ferro, furadeira etc.)?`,
`Ao sair, você protege sua casa (tranca portas, fecha janelas, aciona alarme)?`,
`Quando derrama algo, você pega o material necessário e limpa adequadamente?`,
`Você limpa ou remove os sapatos sujos antes de entrar em ambientes internos?`,
`Você coloca roupas sujas no cesto/local apropriado?`,
`Você guarda as roupas limpas no lugar certo (gaveta, armário, gancho)?`,
`Você usa corretamente produtos de limpeza doméstica?`,
`Em locais públicos movimentados, você mantém-se a uma distância segura do(s) acompanhante(s)/grupo quando combinado?`,
`Você reconhece sinais e símbolos de perigo (proibido, tóxico, alta voltagem)?`,
`No trabalho ou lazer, você segue normas de segurança e usa EPI quando necessário?`,
`Você mantém contato com familiares/amigos por chamadas, mensagens ou vídeo com facilidade?`,
`Você sabe discar para serviços de emergência (190/SAMU) e para contatos de emergência?`,
`Você utiliza pelo menos duas tecnologias sociais (e-mail, mensagens, redes sociais, videochamada)?`,
`Você escova os dentes corretamente (pasta, escovação adequada e enxágue)?`,
`Você costuma escolher opções alimentares saudáveis com regularidade?`,
`Você conhece e comenta os benefícios do exercício físico para a saúde?`,
`Você cobre boca e nariz ao tossir/espirrar?`,
`Quando necessário, você mede sua própria temperatura?`,
`Você entende a função do dinheiro e sua relação com compras/despesas?`,
`Você calcula e paga valores específicos, dando/checando troco exato quando preciso?`,
`Você realiza pequenas compras de forma independente?`,
`Você confere o troco após as compras?`,
`Você guarda dinheiro e cartões com segurança em público (carteira/bolsa/porta-cartões)?`,
`Você respeita as regras e leis locais (lixo, animais, propriedade etc.)?`,
`Você compreende o direito de votar e como exercê-lo?`,
`Você prepara lanches/refeições simples (ex.: sanduíche, itens de micro-ondas)?`,
`Você lava frutas/verduras antes de consumir e cozinha quando necessário?`,
`Você armazena corretamente sobras de comida em recipientes adequados?`,
`Você usa com segurança ao menos dois aparelhos de cozinha simples (torradeira, micro-ondas, abridor elétrico)?`,
`Você usa fogão/forno com segurança (liga/desliga, ajusta temperatura)?`,
`Você define e cumpre metas de curto prazo (ex.: concluir tarefa até uma data)?`,
`Você define e cumpre metas de médio/longo prazo (≥6 meses), como economizar ou melhorar o condicionamento?`
    ]
  },
  {
    key:"SOC",
    label:"Socialização",
    items: [
`Você participa de interações sociais curtas (≥5 min) com uma ou mais pessoas mantendo engajamento?`,
`Você sustenta conversas/interações por cerca de 30 minutos com um grupo pequeno?`,
`Você se protege afastando-se de pessoas agressivas ou de situações destrutivas?`,
`Você busca ativamente companhia e convida pessoas para socializar?`,
`Você entra em um grupo quando os sinais não verbais indicam abertura (olhares, acenos, espaço livre)?`,
`Você evita entrar quando sinais verbais/culturais mostram que não é o momento?`,
`Você nomeia e comunica suas emoções com palavras?`,
`Você reconhece emoções nos outros por pistas verbais e não verbais?`,
`Você toma iniciativa para construir novas amizades com seus pares?`,
`Você mantém amizades estáveis ao longo do tempo?`,
`Você compartilha recursos quando solicitado (materiais, ferramentas, espaços)?`,
`Você pede permissão antes de usar algo que é de outra pessoa?`,
`Você faz revezamento/turn-taking quando solicitado em atividades de grupo?`,
`Você segue regras sociais/jogos/esportes sem precisar ser lembrado?`,
`Você pede ajuda quando a demanda excede sua capacidade (TI, burocracia, equipamentos)?`,
`Você considera e adota sugestões úteis de outras pessoas?`,
`Você muda de tarefa/ambiente sem irritação desproporcional?`,
`Você expressa incômodo de forma assertiva, sem agressão?`,
`Você regula a raiva quando contrariado (negativas, mudanças de plano)?`,
`Você mantém distância interpessoal adequada em contextos sociais?`,
`Você mantém contato visual apropriado à cultura e ao contexto?`,
`Você ajusta volume, ritmo e energia da fala ao ambiente?`,
`Você conversa sem interromper; espera sua vez de falar?`,
`Você ajusta formalidade e postura conforme o grau de intimidade/autoridade do interlocutor?`,
`Você observa e modela comportamentos adequados em contextos novos?`,
`Você evita atrapalhar quem está concentrado (modula ruído/movimentação)?`,
`Você transita entre assuntos quando necessário, sem perseverar de modo inadequado?`,
`Você mantém atenção no interlocutor e demonstra escuta ativa?`,
`Você oferece esclarecimentos extras quando percebe que não foi claro?`,
`Você reconhece que preferências e opiniões alheias podem divergir das suas?`,
`Você inicia conversa aproximando-se pelos interesses do outro?`,
`Você se engaja em conversas sobre temas que não são seus favoritos quando é socialmente necessário?`,
`Você participa de atividades sugeridas por amigos/colegas mesmo não sendo as preferidas (ou acompanha observando com respeito)?`,
`Você cumpre limites e combinações de tempo/regras para telas e lazer acordados com família/companheiro/trabalho?`,
`Você informa planos e horários relevantes a pessoas de confiança quando sai ou muda a rotina (quando combinado)?`,
`Você reconhece riscos de abordagens “boazinhas”/manipuladoras e evita golpes/assédios?`,
`Você age com cautela em situações de risco presencial ou online (convites de desconhecidos, links, eventos com álcool)?`,
`Você entende a intenção persuasiva da publicidade e questiona informações enganosas?`,
`Você pensa nas consequências antes de agir e evita impulsividade?`,
`Você resiste a pressões/manipulações e estabelece limites?`,
`Você participa de saídas em grupo com estrutura/organização (excursão, evento corporativo), seguindo orientações?`,
`Você faz saídas com amigos por conta própria, de forma segura e responsável?`,
`Você planeja com antecedência atividades sociais com amigos/colegas?`,
`Você busca informações de agenda/horários para lazer e eventos (sites, apps, telefonemas)?`,
`Você organiza atividades em grupo que exigem várias etapas (reserva, convites, orçamento, transporte)?`
    ]
  }
];

/* ========= RENDER ========= */
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  let count=0;

  DOMAINS.forEach(domain=>{
    const sec=document.createElement('div');
    sec.className='section';
    sec.textContent=domain.label;
    host.appendChild(sec);

    domain.items.forEach(txt=>{
      count++;
      const qn=String(count).padStart(3,'0');

      const row=document.createElement('div');
      row.className='item';
      row.setAttribute('data-q',String(count));

      const stem=document.createElement('div');
      stem.className='stem';
      stem.id=`s${qn}`;
      stem.textContent = `${count}. ${txt}`;

      const scale=document.createElement('div'); scale.className='scale';
      const CHOICES=[
        {v:0,l:'Nunca'},
        {v:1,l:'Às vezes'},
        {v:2,l:'Frequentemente'}
      ];
      CHOICES.forEach(c=>{
        const lab=document.createElement('label'); lab.className='opt'; lab.title=`${c.l} (${c.v})`;
        const id=`q${qn}_${c.v}`;
        lab.innerHTML=`<input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}"><span>${c.l}</span><small></small>`;
        scale.appendChild(lab);
      });

      row.append(stem,scale);
      host.appendChild(row);
    });
  });

  // Atualiza total para progresso
  $("#progressText").textContent = `Progresso: 0/${count}`;
}

/* ========= ESTADO ========= */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `VINELAND3_ENTREVISTA_${qs("token")||"anon"}`;

/* ========= BOOT ========= */
(async function boot(){
  try{
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow=trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado.");
    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows.length) throw new Error("Paciente não encontrado.");
    patient=prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    // Já respondeu?
    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const doneKeys=RELEASE_KEYS.map(k=>`${k}_FEITO`);
    const anyDoneFlag=doneKeys.some(k=>String(patient[k]||"").trim().toLowerCase()==="sim");
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    renderPatientInfo();
    renderQuestions();
    restoreDraft(); updateProgress();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    $("#progressWrap").style.display="block";
    hideBox("#alert");
  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[
    ["Nome", patient.nome||"-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email||"-"],
    ["WhatsApp", patient.whatsapp||"-"]
  ];
  for(const [k,v] of info){
    const div=document.createElement("div");
    div.className="info";
    div.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ========= RASCUNHO ========= */
function saveDraft(){
  const data={};
  document.querySelectorAll('input[type="radio"][name^="q"]:checked').forEach(el=>{
    data[el.name]=Number(el.value);
  });
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(_){}
}
function restoreDraft(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const data=JSON.parse(raw||"{}");
    Object.entries(data).forEach(([k,v])=>{
      const el=document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el) el.checked=true;
    });
  }catch(_){}
}
function clearDraft(){
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch (_) {
    // ignorar erro de storage bloqueado/sem permissão
  }
}
function countTotalItems(){ return DOMAINS.reduce((a,d)=>a+d.items.length,0); }
function countAnswered(){ return document.querySelectorAll('input[type="radio"][name^="q"]:checked').length; }
function updateProgress(){
  const ans=countAnswered(), tot=countTotalItems();
  $("#progressText").textContent=`Progresso: ${ans}/${tot}`;
  $("#bar").style.width=`${(ans/tot)*100}%`;
}

/* ========= EVENTOS ========= */
addEventListener('change', e=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){ saveDraft(); updateProgress(); }
});
$("#btnSave").addEventListener('click', ()=>{ saveDraft(); setBox("#msg","Rascunho salvo neste dispositivo.","ok"); });
$("#clearDraft").addEventListener('click', ()=>{ clearDraft(); setBox("#msg","Rascunho apagado.","warn"); });

/* ========= CÁLCULOS ========= */
function domainSum(domainIndex){
  // os itens são numerados sequencialmente; somamos percorrendo
  let base=0;
  for(let i=0;i<domainIndex;i++) base += DOMAINS[i].items.length;
  let sum=0;
  for(let j=1;j<=DOMAINS[domainIndex].items.length;j++){
    const qn=String(base+j).padStart(3,'0');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    sum += sel ? Number(sel.value) : 0;
  }
  return sum;
}
function totalSum(){
  let s=0, idxBase=0, n=countTotalItems();
  for(let i=1;i<=n;i++){
    const qn=String(i).padStart(3,'0');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    s += sel ? Number(sel.value) : 0;
  }
  return s;
}

/* ========= SUBMIT ========= */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(sending) return; sending=true; hideBox("#msg");
  const btn=$("#btnSubmit"); const t=btn.textContent; btn.disabled=true; btn.textContent="Enviando…";
  try{
    // validação: tudo respondido
    const tot=countTotalItems();
    for(let i=1;i<=tot;i++){
      const qn=String(i).padStart(3,'0');
      if(!document.querySelector(`input[name="q${qn}"]:checked`)){
        const row=document.querySelector(`.item[data-q="${i}"]`); if(row) row.scrollIntoView({behavior:'smooth',block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // somatórios por domínio
    const somaCOM = domainSum(0);
    const somaAVD = domainSum(1);
    const somaSOC = domainSum(2);
    const total    = totalSum();

    const categoria_csv = [
      `Comunicacao=${somaCOM}`,
      `AVD=${somaAVD}`,
      `Socializacao=${somaSOC}`
    ].join(',');

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: categoria_csv,
      metrics: ""
    });

    // marca como feito
    const patch={}; RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) patch[k]="sim"; });
    if(Object.keys(patch).length===0) patch[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,patch);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; btn.disabled=false; btn.textContent=t;
  }
});
</script>
</body>
</html>

